<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARé–‹ç™ºç’°å¢ƒ æ§‹æˆå›³ - D3.jsç‰ˆ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 1rem;
        }

        .tab-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #aaa;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .diagram-container {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-height: 600px;
        }

        .diagram-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ãƒãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .node {
            cursor: pointer;
        }

        .node rect {
            transition: all 0.3s ease;
        }

        .node:hover rect {
            filter: brightness(1.2) drop-shadow(0 0 15px rgba(255,255,255,0.4));
        }

        .node-label {
            font-size: 11px;
            font-weight: 600;
            fill: #fff;
            text-anchor: middle;
        }

        .node-sublabel {
            font-size: 9px;
            fill: rgba(255,255,255,0.7);
            text-anchor: middle;
        }

        .node-emoji {
            font-size: 18px;
            text-anchor: middle;
            dominant-baseline: central;
        }

        /* ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« - æ›²ç·šå¯¾å¿œ */
        .link {
            fill: none;
            stroke: #4a5568;
            stroke-width: 2px;
            transition: all 0.3s ease;
        }

        .link:hover {
            stroke: #667eea;
            stroke-width: 3px;
        }

        .link-label {
            font-size: 10px;
            fill: #aaa;
            text-anchor: middle;
        }

        .group-label {
            font-size: 13px;
            font-weight: 700;
            fill: #fff;
            opacity: 0.9;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .tooltip {
            position: absolute;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            max-width: 280px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip h3 {
            margin: 0 0 8px 0;
            color: #667eea;
            font-size: 14px;
        }

        .tooltip p {
            margin: 0;
            color: #aaa;
            font-size: 12px;
            line-height: 1.5;
        }

        /* ãƒ‘ã‚¤ãƒãƒ£ãƒ¼ãƒˆ */
        .pie-container {
            display: flex;
            justify-content: center;
            gap: 80px;
            flex-wrap: wrap;
            padding: 20px;
        }

        .pie-chart {
            text-align: center;
        }

        .pie-title {
            font-size: 14px;
            color: #fff;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ARé–‹ç™ºç’°å¢ƒ æ§‹æˆå›³</h1>
            <p class="subtitle">Interactive D3.js Architecture Diagrams</p>
        </header>

        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="overall">1. å…¨ä½“æ§‹æˆ</button>
            <button class="tab-btn" data-tab="ec2-internal">2. EC2å†…éƒ¨æ§‹æˆ</button>
            <button class="tab-btn" data-tab="work-division">3. ä½œæ¥­åˆ†æ‹…</button>
            <button class="tab-btn" data-tab="lifecycle">4. ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«</button>
            <button class="tab-btn" data-tab="auto-stop">5. è‡ªå‹•åœæ­¢</button>
            <button class="tab-btn" data-tab="cost">6. ã‚³ã‚¹ãƒˆ</button>
            <button class="tab-btn" data-tab="file-structure">7. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ</button>
            <button class="tab-btn" data-tab="network">8. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</button>
            <button class="tab-btn" data-tab="aws-permission">9. AWSæ¨©é™</button>
            <button class="tab-btn" data-tab="control-mgmt">10. æ¡ˆä»¶ç®¡ç†</button>
        </nav>

        <div class="diagram-container">
            <div id="overall" class="tab-content active">
                <h2 class="diagram-title">ğŸ—ï¸ å…¨ä½“æ§‹æˆ</h2>
                <div id="diagram-overall"></div>
            </div>

            <div id="ec2-internal" class="tab-content">
                <h2 class="diagram-title">ğŸ–¥ï¸ EC2å†…éƒ¨æ§‹æˆ</h2>
                <div id="diagram-ec2-internal"></div>
            </div>

            <div id="work-division" class="tab-content">
                <h2 class="diagram-title">ğŸ‘¥ ä½œæ¥­åˆ†æ‹…</h2>
                <div id="diagram-work-division"></div>
            </div>

            <div id="lifecycle" class="tab-content">
                <h2 class="diagram-title">ğŸ”„ æ¡ˆä»¶ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«</h2>
                <div id="diagram-lifecycle"></div>
            </div>

            <div id="auto-stop" class="tab-content">
                <h2 class="diagram-title">â±ï¸ è‡ªå‹•åœæ­¢åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯</h2>
                <div id="diagram-auto-stop"></div>
            </div>

            <div id="cost" class="tab-content">
                <h2 class="diagram-title">ğŸ’° ã‚³ã‚¹ãƒˆæ§‹é€ </h2>
                <div id="diagram-cost"></div>
            </div>

            <div id="file-structure" class="tab-content">
                <h2 class="diagram-title">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ</h2>
                <div id="diagram-file-structure"></div>
            </div>

            <div id="network" class="tab-content">
                <h2 class="diagram-title">ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ</h2>
                <div id="diagram-network"></div>
            </div>

            <div id="aws-permission" class="tab-content">
                <h2 class="diagram-title">ğŸ” AWSæ¨©é™æ§‹æˆï¼ˆ3æ®µéšï¼‰</h2>
                <div id="diagram-aws-permission"></div>
            </div>

            <div id="control-mgmt" class="tab-content">
                <h2 class="diagram-title">ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«EC2ã‹ã‚‰ã®æ¡ˆä»¶ç®¡ç†</h2>
                <div id="diagram-control-mgmt"></div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // ========================================
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // ========================================
        // å…±é€šè¨­å®š
        // ========================================
        const width = 1100;
        const height = 520;
        const tooltip = d3.select("#tooltip");

        // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆ5-7è‰²ã«åˆ¶é™ï¼‰
        const colors = {
            device: "#9C27B0",      // ç´«: ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢
            app: "#2196F3",         // é’: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
            aws: "#FF9800",         // ã‚ªãƒ¬ãƒ³ã‚¸: AWS
            service: "#4CAF50",     // ç·‘: ã‚µãƒ¼ãƒ“ã‚¹
            external: "#E91E63",    // ãƒ”ãƒ³ã‚¯: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
            auto: "#607D8B",        // ã‚°ãƒ¬ãƒ¼: è‡ªå‹•å‡¦ç†
        };

        // ã‚°ãƒ«ãƒ¼ãƒ—èƒŒæ™¯è‰²ï¼ˆä½å½©åº¦ï¼‰
        const groupBg = {
            device: "rgba(156, 39, 176, 0.12)",
            app: "rgba(33, 150, 243, 0.12)",
            aws: "rgba(255, 152, 0, 0.12)",
            home: "rgba(76, 175, 80, 0.12)",
        };

        // ========================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ========================================

        // æ›²ç·šãƒ‘ã‚¹ç”Ÿæˆï¼ˆäº¤å·®å›é¿ç”¨ï¼‰
        function curvedPath(x1, y1, x2, y2, curvature = 0.2) {
            const midX = (x1 + x2) / 2;
            const midY = (y1 + y2) / 2;
            const dx = x2 - x1;
            const dy = y2 - y1;
            // å‚ç›´æ–¹å‘ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            const offsetX = -dy * curvature;
            const offsetY = dx * curvature;
            const ctrlX = midX + offsetX;
            const ctrlY = midY + offsetY;
            return `M${x1},${y1} Q${ctrlX},${ctrlY} ${x2},${y2}`;
        }

        // ç›´ç·šãƒ‘ã‚¹ç”Ÿæˆ
        function straightPath(x1, y1, x2, y2) {
            return `M${x1},${y1} L${x2},${y2}`;
        }

        // çŸ¢å°ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
        function addArrowMarker(svg, id, color = "#4a5568") {
            svg.append("defs").append("marker")
                .attr("id", id)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 8)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-4L10,0L0,4")
                .attr("fill", color);
        }

        // ãƒãƒ¼ãƒ‰æç”»ï¼ˆå…±é€šåŒ–ï¼‰
        function drawNode(g, node, showSublabel = true) {
            const nodeG = g.append("g")
                .attr("class", "node")
                .attr("transform", `translate(${node.x}, ${node.y})`);

            // èƒŒæ™¯
            nodeG.append("rect")
                .attr("width", node.w || 110)
                .attr("height", node.h || 50)
                .attr("x", -(node.w || 110) / 2)
                .attr("y", -(node.h || 50) / 2)
                .attr("rx", 10)
                .attr("fill", node.color)
                .style("filter", "drop-shadow(3px 3px 6px rgba(0,0,0,0.3))");

            // ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰
            if (node.emoji) {
                nodeG.append("text")
                    .attr("class", "node-emoji")
                    .attr("y", showSublabel ? -8 : -2)
                    .text(node.emoji);
            }

            // ãƒ©ãƒ™ãƒ«
            nodeG.append("text")
                .attr("class", "node-label")
                .attr("y", node.emoji ? (showSublabel ? 8 : 12) : 0)
                .text(node.label);

            // ã‚µãƒ–ãƒ©ãƒ™ãƒ«
            if (showSublabel && node.sublabel) {
                nodeG.append("text")
                    .attr("class", "node-sublabel")
                    .attr("y", 20)
                    .text(node.sublabel);
            }

            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
            nodeG.on("mouseenter", (event) => {
                tooltip
                    .html(`<h3>${node.emoji || ''} ${node.label}</h3><p>${node.sublabel || node.desc || ''}</p>`)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 10) + "px")
                    .classed("visible", true);
            })
            .on("mouseleave", () => tooltip.classed("visible", false));

            return nodeG;
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—èƒŒæ™¯æç”»
        function drawGroup(g, group) {
            g.append("rect")
                .attr("x", group.x)
                .attr("y", group.y)
                .attr("width", group.w)
                .attr("height", group.h)
                .attr("rx", 14)
                .attr("fill", group.fill)
                .attr("stroke", group.stroke || group.fill.replace("0.12", "0.4"))
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", group.dashed ? "6,4" : "none");

            g.append("text")
                .attr("x", group.x + 14)
                .attr("y", group.y + 24)
                .attr("class", "group-label")
                .text(group.label);
        }

        // ========================================
        // 1. å…¨ä½“æ§‹æˆå›³ï¼ˆéšå±¤å‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ - å·¦â†’å³ãƒ•ãƒ­ãƒ¼å¾¹åº•ï¼‰
        // ========================================
        function drawOverallDiagram() {
            const container = d3.select("#diagram-overall");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, 980, 340])
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%")
                .style("height", "340px");

            addArrowMarker(svg, "arrow-overall");

            const g = svg.append("g").attr("transform", "translate(20, 20)");

            // ===== ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå·¦â†’å³ãƒ•ãƒ­ãƒ¼ï¼‰=====

            // ã‚°ãƒ«ãƒ¼ãƒ—èƒŒæ™¯
            const groups = [
                { label: "ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼è£…å‚™", x: 0, y: 30, w: 120, h: 200, fill: groupBg.device, dashed: true },
                { label: "ğŸ“± Beam Pro", x: 135, y: 50, w: 100, h: 150, fill: groupBg.app, dashed: true },
                { label: "â˜ï¸ AWS", x: 250, y: 0, w: 480, h: 290, fill: groupBg.aws, dashed: false },
                { label: "ğŸŒ å¤–éƒ¨", x: 750, y: 30, w: 130, h: 200, fill: groupBg.home, dashed: true },
            ];
            groups.forEach(grp => drawGroup(g, grp));

            // Control EC2 ã‚°ãƒ«ãƒ¼ãƒ—
            g.append("rect")
                .attr("x", 270)
                .attr("y", 40)
                .attr("width", 170)
                .attr("height", 130)
                .attr("rx", 10)
                .attr("fill", "rgba(255, 152, 0, 0.2)")
                .attr("stroke", "rgba(255, 152, 0, 0.6)")
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", "6,4");

            g.append("text")
                .attr("x", 280)
                .attr("y", 60)
                .attr("class", "group-label")
                .style("font-size", "10px")
                .text("ğŸ® ar-dev-control");

            // ãƒãƒ¼ãƒ‰å®šç¾©ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆé…ç½®ï¼‰
            const nodes = [
                // Layer 0: ãƒ¦ãƒ¼ã‚¶ãƒ¼è£…å‚™
                { id: "xreal", label: "XREAL", sublabel: "ARè¡¨ç¤º", x: 60, y: 75, color: colors.device, emoji: "ğŸ•¶ï¸", w: 80, h: 40 },
                { id: "linkbuds", label: "LinkBuds", sublabel: "éŸ³å£°", x: 60, y: 125, color: colors.device, emoji: "ğŸ§", w: 80, h: 40 },
                { id: "keyboard", label: "XK01 TP", sublabel: "KB", x: 60, y: 175, color: colors.device, emoji: "âŒ¨ï¸", w: 80, h: 40 },

                // Layer 1: Beam Pro
                { id: "termius", label: "Termius", x: 185, y: 100, color: colors.app, emoji: "ğŸ’»", w: 80, h: 40 },
                { id: "chrome", label: "Chrome", x: 185, y: 155, color: colors.app, emoji: "ğŸŒ", w: 80, h: 40 },

                // Layer 2: Control EC2å†…éƒ¨
                { id: "tmux", label: "tmux", sublabel: "ã‚»ãƒƒã‚·ãƒ§ãƒ³", x: 355, y: 85, color: colors.aws, emoji: "ğŸ“º", w: 90, h: 40 },
                { id: "awscli", label: "AWS CLI", sublabel: "èµ·å‹•/åœæ­¢", x: 355, y: 140, color: colors.aws, emoji: "âš¡", w: 90, h: 40 },

                // Layer 3: æ¡ˆä»¶EC2
                { id: "ec2a", label: "ar-dev-acme", sublabel: "ğŸŸ¢ ç¨¼åƒä¸­", x: 530, y: 55, color: colors.aws, emoji: "ğŸ–¥ï¸", w: 110, h: 45 },
                { id: "ec2b", label: "ar-dev-beta", sublabel: "ğŸŸ¡ ç¨¼åƒä¸­", x: 530, y: 120, color: colors.aws, emoji: "ğŸ–¥ï¸", w: 110, h: 45 },
                { id: "ec2c", label: "ar-dev-gamma", sublabel: "âš« åœæ­¢", x: 530, y: 185, color: colors.auto, emoji: "ğŸ–¥ï¸", w: 110, h: 45 },

                // Layer 4: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
                { id: "tunnel", label: "Cloudflare", sublabel: "Tunnel", x: 815, y: 85, color: colors.external, emoji: "â˜ï¸", w: 100, h: 45 },
                { id: "mac", label: "MacBook", sublabel: "Tailscale", x: 815, y: 185, color: colors.service, emoji: "ğŸ’»", w: 100, h: 45 },
            ];

            const nodeMap = {};
            nodes.forEach(n => nodeMap[n.id] = n);

            // ã‚¨ãƒƒã‚¸å®šç¾©
            const edges = [
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼è£…å‚™ â†’ Beam Pro ã¯ã‚°ãƒ«ãƒ¼ãƒ—é–“çŸ¢å°ã¨ã—ã¦å€‹åˆ¥ã«æç”»

                // Beam Pro â†’ Control EC2
                { source: "termius", target: "tmux", label: "SSH", curve: 0 },
                // Chrome â†’ Cloudflare ã¯å€‹åˆ¥ã«ã‚ªãƒ¼ã‚½ã‚´ãƒŠãƒ«ãƒ‘ã‚¹ã§æç”»ï¼ˆAWSå¢ƒç•Œã®ä¸‹ã‚’è¿‚å›ï¼‰

                // Control EC2 â†’ æ¡ˆä»¶EC2
                { source: "tmux", target: "ec2a", label: "", curve: -0.08 },
                { source: "tmux", target: "ec2b", label: "Alt+]", curve: 0 },
                { source: "tmux", target: "ec2c", label: "", curve: 0.08 },

                { source: "awscli", target: "ec2a", label: "", curve: 0.1 },
                { source: "awscli", target: "ec2b", label: "", curve: 0 },
                { source: "awscli", target: "ec2c", label: "", curve: -0.08 },

                // æ¡ˆä»¶EC2 â†’ Cloudflare
                { source: "ec2a", target: "tunnel", label: "", curve: -0.05 },
                { source: "ec2b", target: "tunnel", label: "Tunnel", curve: 0.05 },

            ];

            // ã‚¨ãƒƒã‚¸æç”»ï¼ˆTailscaleä»¥å¤–ï¼‰
            edges.forEach(edge => {
                const s = nodeMap[edge.source];
                const t = nodeMap[edge.target];
                const sw = (s.w || 90) / 2;
                const tw = (t.w || 90) / 2;
                const sx = s.x + sw;
                const sy = s.y;
                const tx = t.x - tw;
                const ty = t.y;

                const path = edge.curve !== 0
                    ? curvedPath(sx, sy, tx, ty, edge.curve)
                    : straightPath(sx, sy, tx, ty);

                g.append("path")
                    .attr("class", "link")
                    .attr("d", path)
                    .attr("marker-end", "url(#arrow-overall)");

                if (edge.label) {
                    const mx = (sx + tx) / 2;
                    const my = (sy + ty) / 2 + (edge.curve * 30);
                    g.append("text")
                        .attr("class", "link-label")
                        .attr("x", mx)
                        .attr("y", my - 6)
                        .style("font-size", "9px")
                        .text(edge.label);
                }
            });

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼è£…å‚™ â†’ Beam Proï¼ˆã‚°ãƒ«ãƒ¼ãƒ—é–“çŸ¢å°ã€1æœ¬ã«é›†ç´„ï¼‰
            // ã‚°ãƒ«ãƒ¼ãƒ—: ãƒ¦ãƒ¼ã‚¶ãƒ¼è£…å‚™ x=0-120, Beam Pro x=135-235
            const userEquipRight = 120;  // ãƒ¦ãƒ¼ã‚¶ãƒ¼è£…å‚™ã‚°ãƒ«ãƒ¼ãƒ—å³ç«¯
            const beamProLeft = 135;     // Beam Proã‚°ãƒ«ãƒ¼ãƒ—å·¦ç«¯
            const groupConnectY = 125;   // æ¥ç¶šã®Yåº§æ¨™ï¼ˆLinkBudsã¨åŒã˜é«˜ã•ï¼‰

            g.append("path")
                .attr("class", "link")
                .attr("d", straightPath(userEquipRight, groupConnectY, beamProLeft, groupConnectY))
                .attr("stroke-width", 3)  // ã‚°ãƒ«ãƒ¼ãƒ—é–“ã¯å¤ªã‚ã«
                .attr("marker-end", "url(#arrow-overall)");

            // TailscaleçŸ¢å°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªã‚ªãƒ¼ã‚½ã‚´ãƒŠãƒ«ãƒ‘ã‚¹ï¼‰
            const tmux = nodeMap["tmux"];
            const mac = nodeMap["mac"];
            const tmuxRight = tmux.x + tmux.w / 2;  // 400
            const awsRight = 730 + 15;  // AWSå¢ƒç•Œ(250+480) + ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            const macLeft = mac.x - mac.w / 2;  // 765
            const macY = mac.y;  // 185

            // tmuxå³ç«¯ â†’ æ°´å¹³ã«å³ â†’ ä¸‹ã¸macY â†’ å³ã¸MacBook
            const tailscalePath = `M${tmuxRight},${tmux.y} L${awsRight},${tmux.y} L${awsRight},${macY} L${macLeft},${macY}`;

            g.append("path")
                .attr("class", "link")
                .attr("d", tailscalePath)
                .attr("stroke-dasharray", "4,3")
                .attr("marker-end", "url(#arrow-overall)");

            // Tailscaleãƒ©ãƒ™ãƒ«
            g.append("text")
                .attr("class", "link-label")
                .attr("x", awsRight + 15)
                .attr("y", (tmux.y + macY) / 2)
                .style("font-size", "9px")
                .text("Tailscale");

            // Chrome â†’ Cloudflareï¼ˆAWSå¢ƒç•Œã®ä¸‹ã‚’è¿‚å›ã—ã€å³å´ã‹ã‚‰æ¥ç¶šï¼‰
            const chrome = nodeMap["chrome"];
            const cloudflare = nodeMap["tunnel"];
            const chromeX = chrome.x;  // Chromeã®ä¸­å¤®X
            const chromeBottom = chrome.y + chrome.h / 2;  // Chromeã®ä¸‹ç«¯
            const awsBottom = 290 + 15;  // AWSä¸‹ç«¯ + ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            const cloudflareRight = cloudflare.x + cloudflare.w / 2 + 35;  // Cloudflareã®å³ç«¯ + ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆå¢ƒç•Œã‹ã‚‰é›¢ã™ï¼‰
            const cloudflareY = cloudflare.y;

            // Chromeä¸‹ç«¯ â†’ ä¸‹ã¸ â†’ AWSå¢ƒç•Œã®ä¸‹ â†’ å³ã¸ â†’ Cloudflareå³å´ â†’ ä¸Šã¸ â†’ å³ã‹ã‚‰æ¥ç¶š
            const chromePath = `M${chromeX},${chromeBottom} L${chromeX},${awsBottom} L${cloudflareRight},${awsBottom} L${cloudflareRight},${cloudflareY} L${cloudflare.x + cloudflare.w/2},${cloudflareY}`;

            g.append("path")
                .attr("class", "link")
                .attr("d", chromePath)
                .attr("marker-end", "url(#arrow-overall)");

            // HTTPSãƒ©ãƒ™ãƒ«
            g.append("text")
                .attr("class", "link-label")
                .attr("x", (chromeX + cloudflareRight) / 2)
                .attr("y", awsBottom - 5)
                .style("font-size", "9px")
                .text("HTTPS");

            // ãƒãƒ¼ãƒ‰æç”»
            nodes.forEach(node => drawNode(g, node));
        }

        // ========================================
        // 2. EC2å†…éƒ¨æ§‹æˆå›³
        // ========================================
        function drawEC2InternalDiagram() {
            const container = d3.select("#diagram-ec2-internal");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, width, height])
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%")
                .style("height", "520px");

            const g = svg.append("g").attr("transform", "translate(20, 20)");

            // ãƒ¡ã‚¤ãƒ³EC2ãƒœãƒƒã‚¯ã‚¹
            g.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", 750)
                .attr("height", 460)
                .attr("rx", 16)
                .attr("fill", groupBg.aws)
                .attr("stroke", "rgba(255, 152, 0, 0.5)")
                .attr("stroke-width", 2);

            g.append("text")
                .attr("x", 20)
                .attr("y", 35)
                .attr("class", "group-label")
                .style("font-size", "16px")
                .text("ğŸ–¥ï¸ EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆæ¡ˆä»¶ã”ã¨ï¼‰");

            // ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—
            const subGroups = [
                { label: "ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ„ãƒ¼ãƒ«", x: 20, y: 55, w: 350, h: 180, fill: groupBg.app },
                { label: "ğŸ“º tmux ã‚»ãƒƒã‚·ãƒ§ãƒ³", x: 390, y: 55, w: 340, h: 180, fill: "rgba(76, 175, 80, 0.12)" },
                { label: "âš™ï¸ systemd ã‚µãƒ¼ãƒ“ã‚¹", x: 20, y: 255, w: 350, h: 100, fill: "rgba(156, 39, 176, 0.12)" },
                { label: "ğŸ”‘ IAMãƒ­ãƒ¼ãƒ«", x: 390, y: 255, w: 340, h: 60, fill: "rgba(244, 67, 54, 0.12)" },
            ];
            subGroups.forEach(grp => {
                g.append("rect")
                    .attr("x", grp.x)
                    .attr("y", grp.y)
                    .attr("width", grp.w)
                    .attr("height", grp.h)
                    .attr("rx", 10)
                    .attr("fill", grp.fill)
                    .attr("stroke", grp.fill.replace("0.12", "0.4"))
                    .attr("stroke-dasharray", "6,4");

                g.append("text")
                    .attr("x", grp.x + 14)
                    .attr("y", grp.y + 24)
                    .attr("class", "group-label")
                    .style("font-size", "12px")
                    .text(grp.label);
            });

            // ãƒ„ãƒ¼ãƒ«
            const tools = [
                { label: "AWS CLI", x: 80, y: 120, color: colors.app, emoji: "â˜ï¸", w: 90, h: 40 },
                { label: "Node.js", x: 185, y: 120, color: colors.service, emoji: "ğŸ“¦", w: 90, h: 40 },
                { label: "GitHub CLI", x: 290, y: 120, color: colors.auto, emoji: "ğŸ™", w: 90, h: 40 },
                { label: "Playwright", x: 80, y: 175, color: colors.service, emoji: "ğŸ­", w: 90, h: 40 },
                { label: "cloudflared", x: 185, y: 175, color: colors.external, emoji: "â˜ï¸", w: 90, h: 40 },
                { label: "code-server", x: 290, y: 175, color: colors.app, emoji: "ğŸ“", w: 90, h: 40 },
            ];
            tools.forEach(t => drawNode(g, t, false));

            // tmuxãƒšã‚¤ãƒ³
            const panes = [
                { label: "ãƒšã‚¤ãƒ³ 0", sublabel: "é–‹ç™ºã‚µãƒ¼ãƒãƒ¼", x: 470, y: 120, color: colors.service, emoji: "ğŸš€", w: 100, h: 45 },
                { label: "ãƒšã‚¤ãƒ³ 1", sublabel: "Tunnel (ã‚¢ãƒ—ãƒª)", x: 590, y: 120, color: colors.external, emoji: "ğŸ”—", w: 100, h: 45 },
                { label: "ãƒšã‚¤ãƒ³ 2", sublabel: "Tunnel (IDE)", x: 590, y: 180, color: colors.external, emoji: "ğŸ”—", w: 100, h: 45 },
            ];
            panes.forEach(p => drawNode(g, p, true));

            // ã‚µãƒ¼ãƒ“ã‚¹
            const services = [
                { label: "auto-stop.service", sublabel: "ã‚¢ã‚¤ãƒ‰ãƒ«â†’è‡ªå‹•åœæ­¢", x: 130, y: 315, color: colors.auto, emoji: "â±ï¸", w: 140, h: 45 },
                { label: "code-server.service", sublabel: "ãƒ–ãƒ©ã‚¦ã‚¶IDE", x: 290, y: 315, color: colors.app, emoji: "ğŸ’»", w: 140, h: 45 },
            ];
            services.forEach(s => drawNode(g, s, true));

            // IAMãƒ­ãƒ¼ãƒ«èª¬æ˜
            g.append("text")
                .attr("x", 560)
                .attr("y", 295)
                .attr("fill", "#aaa")
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text("ğŸ” ä»–ç’°å¢ƒæ“ä½œæ¨©é™ï¼ˆè‡ªå‹•èªè¨¼ï¼‰");

            // å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
            drawGroup(g, { label: "ğŸŒ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹", x: 800, y: 55, w: 180, h: 200, fill: "rgba(233, 30, 99, 0.12)", dashed: true });

            const externals = [
                { label: "GitHub", x: 890, y: 110, color: colors.auto, emoji: "ğŸ™", w: 90, h: 40 },
                { label: "Cloudflare", x: 890, y: 160, color: colors.external, emoji: "â˜ï¸", w: 90, h: 40 },
                { label: "Staging", x: 890, y: 210, color: colors.service, emoji: "ğŸš€", w: 90, h: 40 },
            ];
            externals.forEach(e => drawNode(g, e, false));

            // Beam Pro
            drawGroup(g, { label: "ğŸ“± Beam Pro", x: 800, y: 280, w: 180, h: 80, fill: groupBg.device, dashed: true });
            g.append("text")
                .attr("x", 890)
                .attr("y", 330)
                .attr("fill", "#aaa")
                .attr("text-anchor", "middle")
                .style("font-size", "11px")
                .text("ğŸŒ Chromeï¼ˆã‚¢ãƒ—ãƒªç¢ºèªï¼‰");
        }

        // ========================================
        // 3. ä½œæ¥­åˆ†æ‹…å›³
        // ========================================
        function drawWorkDivisionDiagram() {
            const container = d3.select("#diagram-work-division");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, width, height])
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%")
                .style("height", "520px");

            const g = svg.append("g").attr("transform", "translate(30, 20)");

            // 3ã¤ã®ã‚«ãƒ©ãƒ 
            const columns = [
                { label: "ğŸ‘¤ äººã®ä½œæ¥­", x: 0, fill: "rgba(233, 30, 99, 0.12)" },
                { label: "ğŸ¤– Claude Codeä½œæ¥­", x: 360, fill: "rgba(0, 188, 212, 0.12)" },
                { label: "âš™ï¸ è‡ªå‹•", x: 720, fill: "rgba(96, 125, 139, 0.12)" },
            ];

            columns.forEach(col => {
                g.append("rect")
                    .attr("x", col.x)
                    .attr("y", 0)
                    .attr("width", 340)
                    .attr("height", 460)
                    .attr("rx", 14)
                    .attr("fill", col.fill)
                    .attr("stroke", col.fill.replace("0.12", "0.4"))
                    .attr("stroke-width", 2);

                g.append("text")
                    .attr("x", col.x + 170)
                    .attr("y", 35)
                    .attr("text-anchor", "middle")
                    .attr("class", "group-label")
                    .style("font-size", "16px")
                    .text(col.label);
            });

            // äººã®ä½œæ¥­
            const humanTasks = [
                "ğŸ›’ ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢è³¼å…¥ãƒ»æ¥ç¶š",
                "ğŸ”‘ aws login",
                "ğŸ™ gh auth login",
                "â˜ï¸ cloudflared tunnel login",
                "ğŸ”— tailscale up",
                "ğŸ“± Beam Proè¨­å®š",
            ];

            humanTasks.forEach((task, i) => {
                const y = 80 + i * 60;
                g.append("rect")
                    .attr("x", 20)
                    .attr("y", y)
                    .attr("width", 300)
                    .attr("height", 45)
                    .attr("rx", 10)
                    .attr("fill", colors.external)
                    .style("filter", "drop-shadow(2px 2px 4px rgba(0,0,0,0.2))");

                g.append("text")
                    .attr("x", 170)
                    .attr("y", y + 28)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#fff")
                    .style("font-size", "13px")
                    .style("font-weight", "600")
                    .text(task);
            });

            // Claude Codeä½œæ¥­
            const claudeTasks = [
                "â˜ï¸ EC2ä½œæˆãƒ»å‰Šé™¤",
                "ğŸ” IAMãƒ­ãƒ¼ãƒ«ä½œæˆ",
                "ğŸ”§ ç’°å¢ƒæ§‹ç¯‰",
                "ğŸ™ GitHubæ“ä½œ",
                "ğŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼æ“ä½œ",
                "ğŸ” éšœå®³èª¿æŸ»",
                "âš¡ EC2èµ·å‹•ãƒ»åœæ­¢",
            ];

            claudeTasks.forEach((task, i) => {
                const y = 65 + i * 55;
                g.append("rect")
                    .attr("x", 380)
                    .attr("y", y)
                    .attr("width", 300)
                    .attr("height", 42)
                    .attr("rx", 10)
                    .attr("fill", "#00BCD4")
                    .style("filter", "drop-shadow(2px 2px 4px rgba(0,0,0,0.2))");

                g.append("text")
                    .attr("x", 530)
                    .attr("y", y + 26)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#fff")
                    .style("font-size", "13px")
                    .style("font-weight", "600")
                    .text(task);
            });

            // è‡ªå‹•
            g.append("rect")
                .attr("x", 740)
                .attr("y", 180)
                .attr("width", 300)
                .attr("height", 100)
                .attr("rx", 12)
                .attr("fill", colors.auto)
                .style("filter", "drop-shadow(2px 2px 4px rgba(0,0,0,0.2))");

            g.append("text")
                .attr("x", 890)
                .attr("y", 220)
                .attr("text-anchor", "middle")
                .attr("fill", "#fff")
                .style("font-size", "14px")
                .style("font-weight", "600")
                .text("â±ï¸ SSHåˆ‡æ–­å¾Œ3æ™‚é–“ã§");

            g.append("text")
                .attr("x", 890)
                .attr("y", 250)
                .attr("text-anchor", "middle")
                .attr("fill", "#fff")
                .style("font-size", "14px")
                .style("font-weight", "600")
                .text("EC2è‡ªå‹•åœæ­¢");
        }

        // ========================================
        // 4. æ¡ˆä»¶ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å›³
        // ========================================
        function drawLifecycleDiagram() {
            const container = d3.select("#diagram-lifecycle");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("viewBox", [-10, 0, 900, 420])
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%")
                .style("height", "420px");

            addArrowMarker(svg, "arrow-lifecycle");

            const g = svg.append("g").attr("transform", "translate(30, 20)");

            // ãƒ•ã‚§ãƒ¼ã‚ºèƒŒæ™¯ï¼ˆãƒ©ãƒ™ãƒ«ã¨ãƒãƒ¼ãƒ‰ãŒé‡ãªã‚‰ãªã„ã‚ˆã†é«˜ã•ã‚’èª¿æ•´ï¼‰
            const phases = [
                { label: "ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆåˆå›ã®ã¿ï¼‰", x: 0, y: 0, w: 820, h: 100, fill: groupBg.app },
                { label: "ğŸ”„ æ—¥æ¬¡é‹ç”¨", x: 0, y: 120, w: 720, h: 100, fill: "rgba(76, 175, 80, 0.12)" },
                { label: "ğŸ—‘ï¸ æ¡ˆä»¶çµ‚äº†", x: 0, y: 240, w: 180, h: 90, fill: "rgba(244, 67, 54, 0.12)" },
            ];
            phases.forEach(p => drawGroup(g, p));

            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ä¸‹ã«é…ç½®: y = groupY + 35 + paddingï¼‰
            const setupY = 60;  // ã‚°ãƒ«ãƒ¼ãƒ—y=0 + ãƒ©ãƒ™ãƒ«é«˜ã•35 + ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°25
            const setupSteps = [
                { label: "ğŸ“„ Docæ¸¡ã™", x: 70, y: setupY, color: colors.app, w: 100, h: 40 },
                { label: "âœï¸ æ¡ˆä»¶å…¥åŠ›", x: 190, y: setupY, color: colors.app, w: 100, h: 40 },
                { label: "â˜ï¸ EC2ä½œæˆ", x: 310, y: setupY, color: colors.aws, w: 100, h: 40 },
                { label: "ğŸ”§ ç’°å¢ƒæ§‹ç¯‰", x: 430, y: setupY, color: colors.aws, w: 100, h: 40 },
                { label: "ğŸ”‘ èªè¨¼ä½œæ¥­", x: 550, y: setupY, color: colors.external, w: 100, h: 40 },
                { label: "âœ… å‹•ä½œç¢ºèª", x: 670, y: setupY, color: colors.service, w: 100, h: 40 },
            ];

            setupSteps.forEach((step, i) => {
                drawNode(g, { ...step, emoji: null }, false);

                if (i < setupSteps.length - 1) {
                    const next = setupSteps[i + 1];
                    g.append("path")
                        .attr("class", "link")
                        .attr("d", straightPath(step.x + 50, step.y, next.x - 50, next.y))
                        .attr("marker-end", "url(#arrow-lifecycle)");
                }
            });

            // æ—¥æ¬¡é‹ç”¨ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—y=120 + ãƒ©ãƒ™ãƒ«é«˜ã•35 + ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°25 = 180ï¼‰
            const dailyY = 180;
            const dailySteps = [
                { label: "âš¡ EC2èµ·å‹•", x: 70, y: dailyY, color: colors.aws, w: 100, h: 40 },
                { label: "ğŸ“º tmuxæ¥ç¶š", x: 200, y: dailyY, color: colors.aws, w: 100, h: 40 },
                { label: "ğŸ’» é–‹ç™ºä½œæ¥­", x: 340, y: dailyY, color: colors.service, w: 110, h: 40 },
                { label: "ğŸšª SSHåˆ‡æ–­", x: 480, y: dailyY, color: colors.auto, w: 100, h: 40 },
                { label: "â±ï¸ 3hå¾Œåœæ­¢", x: 610, y: dailyY, color: colors.auto, w: 100, h: 40 },
            ];

            dailySteps.forEach((step, i) => {
                drawNode(g, { ...step, emoji: null }, false);

                if (i < dailySteps.length - 1) {
                    const next = dailySteps[i + 1];
                    g.append("path")
                        .attr("class", "link")
                        .attr("d", straightPath(step.x + 50, step.y, next.x - 50, next.y))
                        .attr("marker-end", "url(#arrow-lifecycle)");
                }
            });

            // æ—¥æ¬¡ãƒ«ãƒ¼ãƒ—çŸ¢å°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã®å¤–å´ã‚’é€šã‚‹ï¼‰
            // æ—¥æ¬¡é‹ç”¨ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸‹ç«¯ = 120 + 100 = 220ã€ãã®ä¸‹ã‚’é€šã™
            const loopBottom = 360;  // æ¡ˆä»¶çµ‚äº†ã‚°ãƒ«ãƒ¼ãƒ—(240+90=330)ã‚ˆã‚Šä¸‹
            const loopRight = 750;   // æ—¥æ¬¡é‹ç”¨ã‚°ãƒ«ãƒ¼ãƒ—(720)ã‚ˆã‚Šå³
            const loopLeft = -30;    // å·¦å´ã¸ã®æŒ¯ã‚Šå¹…ï¼ˆEC2èµ·å‹•ã®å·¦ç«¯ã‚ˆã‚Šæ›´ã«å·¦ï¼‰
            const firstNodeLeft = 20; // EC2èµ·å‹•ãƒãƒ¼ãƒ‰ã®å·¦ç«¯
            g.append("path")
                .attr("class", "link")
                .attr("d", `M660,${dailyY} L${loopRight},${dailyY} L${loopRight},${loopBottom} L${loopLeft},${loopBottom} L${loopLeft},${dailyY} L${firstNodeLeft},${dailyY}`)
                .attr("stroke-dasharray", "6,4")
                .attr("marker-end", "url(#arrow-lifecycle)");

            // ç¿Œæ—¥ãƒ©ãƒ™ãƒ«ï¼ˆãƒ«ãƒ¼ãƒ—ã®ä¸‹éƒ¨ã«é…ç½®ï¼‰
            g.append("text")
                .attr("x", 350)
                .attr("y", loopBottom + 15)
                .attr("class", "link-label")
                .text("ğŸ”„ ç¿Œæ—¥");

            // æ¡ˆä»¶çµ‚äº†ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—y=240 + ãƒ©ãƒ™ãƒ«é«˜ã•35 + ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°20 = 295ï¼‰
            const endY = 295;
            drawNode(g, { label: "ğŸ—‘ï¸ ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤", x: 90, y: endY, color: colors.external, w: 130, h: 40, emoji: null }, false);
        }

        // ========================================
        // 5. è‡ªå‹•åœæ­¢åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        // ========================================
        function drawAutoStopDiagram() {
            const container = d3.select("#diagram-auto-stop");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, 900, 480])
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%")
                .style("height", "480px");

            addArrowMarker(svg, "arrow-flow", "#4a5568");

            const g = svg.append("g").attr("transform", "translate(180, 30)");

            // ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆãƒãƒ¼ãƒ‰
            const flowNodes = [
                { id: "start", label: "â±ï¸ 5åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯", x: 200, y: 30, type: "rect", color: colors.app },
                { id: "ssh", label: "SSHæ¥ç¶šã‚ã‚Šï¼Ÿ", x: 200, y: 130, type: "diamond", color: colors.aws },
                { id: "active", label: "âœ… æ¥ç¶šä¸­", sublabel: "ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ", x: 50, y: 250, type: "rect", color: colors.service },
                { id: "idle", label: "â³ æœªæ¥ç¶š", sublabel: "ã‚¿ã‚¤ãƒãƒ¼ç¶™ç¶š", x: 350, y: 250, type: "rect", color: colors.auto },
                { id: "check3h", label: "3æ™‚é–“çµŒéï¼Ÿ", x: 350, y: 350, type: "diamond", color: colors.aws },
                { id: "stop", label: "ğŸ›‘ EC2åœæ­¢", x: 350, y: 440, type: "rect", color: colors.external },
            ];

            // ãƒãƒ¼ãƒ‰æç”»
            flowNodes.forEach(node => {
                const nodeG = g.append("g")
                    .attr("transform", `translate(${node.x}, ${node.y})`);

                if (node.type === "diamond") {
                    nodeG.append("polygon")
                        .attr("points", "0,-40 70,0 0,40 -70,0")
                        .attr("fill", node.color)
                        .style("filter", "drop-shadow(2px 2px 4px rgba(0,0,0,0.3))");

                    nodeG.append("text")
                        .attr("text-anchor", "middle")
                        .attr("fill", "#fff")
                        .attr("y", 5)
                        .style("font-size", "12px")
                        .style("font-weight", "600")
                        .text(node.label);
                } else {
                    nodeG.append("rect")
                        .attr("x", -70)
                        .attr("y", -25)
                        .attr("width", 140)
                        .attr("height", 50)
                        .attr("rx", 10)
                        .attr("fill", node.color)
                        .style("filter", "drop-shadow(2px 2px 4px rgba(0,0,0,0.3))");

                    nodeG.append("text")
                        .attr("text-anchor", "middle")
                        .attr("fill", "#fff")
                        .attr("y", node.sublabel ? -3 : 5)
                        .style("font-size", "12px")
                        .style("font-weight", "600")
                        .text(node.label);

                    if (node.sublabel) {
                        nodeG.append("text")
                            .attr("text-anchor", "middle")
                            .attr("fill", "rgba(255,255,255,0.7)")
                            .attr("y", 15)
                            .style("font-size", "10px")
                            .text(node.sublabel);
                    }
                }
            });

            // çŸ¢å°
            const arrows = [
                { from: [200, 55], to: [200, 90], label: "" },
                { from: [130, 130], to: [50, 225], label: "ã¯ã„" },
                { from: [270, 130], to: [350, 225], label: "ã„ã„ãˆ" },
                { from: [350, 275], to: [350, 310], label: "" },
                { from: [350, 390], to: [350, 415], label: "ã¯ã„" },
            ];

            arrows.forEach(arr => {
                g.append("path")
                    .attr("class", "link")
                    .attr("d", `M${arr.from[0]},${arr.from[1]} L${arr.to[0]},${arr.to[1]}`)
                    .attr("marker-end", "url(#arrow-flow)");

                if (arr.label) {
                    const mx = (arr.from[0] + arr.to[0]) / 2;
                    const my = (arr.from[1] + arr.to[1]) / 2;
                    g.append("text")
                        .attr("x", mx + 15)
                        .attr("y", my)
                        .attr("class", "link-label")
                        .text(arr.label);
                }
            });

            // ãƒ«ãƒ¼ãƒ—çŸ¢å°
            g.append("path")
                .attr("class", "link")
                .attr("d", "M-20,250 Q-60,250 -60,140 Q-60,30 130,30")
                .attr("marker-end", "url(#arrow-flow)");

            g.append("path")
                .attr("class", "link")
                .attr("d", "M420,350 Q500,350 500,180 Q500,30 270,30")
                .attr("marker-end", "url(#arrow-flow)");

            g.append("text")
                .attr("x", 540)
                .attr("y", 200)
                .attr("class", "link-label")
                .text("ã„ã„ãˆ");

            // ãƒã‚¤ãƒ³ãƒˆèª¬æ˜
            const points = [
                "âœ… ã‚·ãƒ³ãƒ—ãƒ«ãªåˆ¤å®š: SSHæ¥ç¶šã®æœ‰ç„¡ã®ã¿",
                "âœ… 3æ™‚é–“ã®çŒ¶äºˆ: Claude Codeã«ä¾é ¼ã—ã¦é›¢å¸­OK",
                "âœ… è¤‡æ•°æ¡ˆä»¶å¯¾å¿œ: æ¡ˆä»¶åˆ‡ã‚Šæ›¿ãˆã‚‚å®‰å¿ƒ",
            ];

            const infoG = g.append("g").attr("transform", "translate(500, 250)");
            infoG.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", 220)
                .attr("height", 120)
                .attr("rx", 10)
                .attr("fill", "rgba(0,0,0,0.3)");

            infoG.append("text")
                .attr("x", 15)
                .attr("y", 28)
                .attr("fill", "#fff")
                .style("font-weight", "700")
                .style("font-size", "13px")
                .text("ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ");

            points.forEach((point, i) => {
                infoG.append("text")
                    .attr("x", 15)
                    .attr("y", 55 + i * 22)
                    .attr("fill", "#aaa")
                    .style("font-size", "10px")
                    .text(point);
            });
        }

        // ========================================
        // 6. ã‚³ã‚¹ãƒˆæ§‹é€ ï¼ˆãƒ‘ã‚¤ãƒãƒ£ãƒ¼ãƒˆï¼‰
        // ========================================
        function drawCostDiagram() {
            const container = d3.select("#diagram-cost");
            container.selectAll("*").remove();

            const pieContainer = container.append("div")
                .attr("class", "pie-container");

            const datasets = [
                {
                    title: "ğŸ’° 24æ™‚é–“ç¨¼åƒæ™‚ æœˆé¡ã‚³ã‚¹ãƒˆ $11.1ï¼ˆã‚¹ãƒãƒƒãƒˆï¼‰",
                    data: [
                        { label: "EC2 (t4g.small)", value: 5.0, color: colors.aws },
                        { label: "EBS (30GB gp3)", value: 2.88, color: colors.app },
                        { label: "ãã®ä»–", value: 3.22, color: colors.auto }
                    ]
                },
                {
                    title: "ğŸ’µ è‡ªå‹•åœæ­¢é‹ç”¨æ™‚ æœˆé¡ã‚³ã‚¹ãƒˆ ç´„$7",
                    data: [
                        { label: "EC2 (å®Ÿç¨¼åƒåˆ†)", value: 4, color: colors.aws },
                        { label: "EBS (30GB gp3)", value: 2.88, color: colors.app }
                    ]
                }
            ];

            datasets.forEach(dataset => {
                const chartDiv = pieContainer.append("div")
                    .attr("class", "pie-chart");

                chartDiv.append("div")
                    .attr("class", "pie-title")
                    .text(dataset.title);

                const svg = chartDiv.append("svg")
                    .attr("width", 320)
                    .attr("height", 320);

                const chartG = svg.append("g")
                    .attr("transform", "translate(160, 140)");

                const pie = d3.pie()
                    .value(d => d.value)
                    .sort(null);

                const arc = d3.arc()
                    .innerRadius(45)
                    .outerRadius(95);

                const labelArc = d3.arc()
                    .innerRadius(110)
                    .outerRadius(110);

                const arcs = chartG.selectAll(".arc")
                    .data(pie(dataset.data))
                    .join("g")
                    .attr("class", "arc");

                arcs.append("path")
                    .attr("d", arc)
                    .attr("fill", d => d.data.color)
                    .style("filter", "drop-shadow(2px 2px 4px rgba(0,0,0,0.3))")
                    .style("stroke", "#1a1a2e")
                    .style("stroke-width", 2);

                arcs.append("text")
                    .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#fff")
                    .style("font-size", "12px")
                    .style("font-weight", "600")
                    .text(d => `$${d.data.value}`);

                // å‡¡ä¾‹
                const legend = svg.append("g")
                    .attr("transform", "translate(20, 260)");

                dataset.data.forEach((item, i) => {
                    const legendItem = legend.append("g")
                        .attr("transform", `translate(${i * 100}, 0)`);

                    legendItem.append("rect")
                        .attr("width", 14)
                        .attr("height", 14)
                        .attr("rx", 3)
                        .attr("fill", item.color);

                    legendItem.append("text")
                        .attr("x", 18)
                        .attr("y", 11)
                        .attr("fill", "#aaa")
                        .style("font-size", "10px")
                        .text(item.label.substring(0, 12));
                });
            });
        }

        // ========================================
        // 7. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆå›³
        // ========================================
        function drawFileStructureDiagram() {
            const container = d3.select("#diagram-file-structure");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, width, 420])
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%")
                .style("height", "420px");

            addArrowMarker(svg, "arrow-file");

            const g = svg.append("g").attr("transform", "translate(30, 20)");

            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚°ãƒ«ãƒ¼ãƒ—
            drawGroup(g, { label: "ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹æˆ", x: 0, y: 0, w: 560, h: 200, fill: groupBg.app, dashed: false });

            const docs = [
                { label: "01-human-prerequisites", sublabel: "ğŸ‘¤ äº‹å‰ä½œæ¥­ã‚¬ã‚¤ãƒ‰", x: 150, y: 70, color: colors.external, w: 200, h: 45 },
                { label: "02-control-ec2-setup", sublabel: "ğŸ¤– ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«EC2æ§‹ç¯‰", x: 150, y: 130, color: colors.app, w: 200, h: 45 },
                { label: "03-new-project-setup", sublabel: "ğŸ¤– æ–°è¦æ¡ˆä»¶ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—", x: 400, y: 70, color: colors.app, w: 190, h: 45 },
                { label: "04-operations", sublabel: "ğŸ¤– é‹ç”¨ã‚¿ã‚¹ã‚¯é›†", x: 400, y: 130, color: colors.service, w: 190, h: 45 },
                { label: "05-scenario-guide", sublabel: "ğŸ“– ã‚·ãƒŠãƒªã‚ªã‚¬ã‚¤ãƒ‰", x: 400, y: 190, color: colors.service, w: 190, h: 45 },
            ];

            docs.forEach(doc => drawNode(g, { ...doc, emoji: null }, true));

            // ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
            const flowY = 300;
            const flowNodes = [
                { label: "ğŸ‘¤ äºº", x: 80, y: flowY, color: colors.external, w: 80, h: 45 },
                { label: "ğŸ“„ Doc1", x: 190, y: flowY, color: colors.external, w: 80, h: 45 },
                { label: "ğŸ“„ Doc2/3", x: 300, y: flowY, color: colors.app, w: 90, h: 45 },
                { label: "ğŸ¤– Claude", x: 420, y: flowY, color: "#00BCD4", w: 90, h: 45 },
                { label: "âœ… å®Œäº†", x: 540, y: flowY, color: colors.service, w: 80, h: 45 },
                { label: "ğŸ“„ Doc4/5", x: 660, y: flowY, color: colors.service, w: 90, h: 45 },
            ];

            flowNodes.forEach((node, i) => {
                drawNode(g, { ...node, emoji: null }, false);

                if (i < flowNodes.length - 1) {
                    const next = flowNodes[i + 1];
                    g.append("path")
                        .attr("class", "link")
                        .attr("d", straightPath(node.x + node.w / 2, node.y, next.x - next.w / 2, next.y))
                        .attr("marker-end", "url(#arrow-file)");
                }
            });

            // ãƒ©ãƒ™ãƒ«
            const labels = ["èª­ã‚“ã§å®Ÿè¡Œ", "å®Œäº†å¾Œæ¸¡ã™", "è‡ªå‹•å®Ÿè¡Œ", "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†", "æ—¥å¸¸é‹ç”¨"];
            labels.forEach((label, i) => {
                g.append("text")
                    .attr("x", 135 + i * 115)
                    .attr("y", flowY - 35)
                    .attr("class", "link-label")
                    .text(label);
            });
        }

        // ========================================
        // 8. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆå›³ï¼ˆå·¦â†’å³ãƒ•ãƒ­ãƒ¼ã€ã‚°ãƒ«ãƒ¼ãƒ—å¢ƒç•ŒçµŒç”±ï¼‰
        // ========================================
        function drawNetworkDiagram() {
            const container = d3.select("#diagram-network");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, 880, 380])
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%")
                .style("height", "380px");

            addArrowMarker(svg, "arrow-network");

            const g = svg.append("g").attr("transform", "translate(20, 20)");

            // ã‚°ãƒ«ãƒ¼ãƒ—å¢ƒç•Œã®å®šç¾©
            const AWS_LEFT = 160;
            const AWS_RIGHT = 560;
            const AWS_TOP = 20;
            const AWS_BOTTOM = 320;

            // é ˜åŸŸï¼ˆå·¦â†’å³ã®é †åºã§é…ç½®ï¼‰
            const regions = [
                { label: "ğŸ“± ãƒ¢ãƒã‚¤ãƒ«", x: 0, y: 70, w: 140, h: 100, fill: groupBg.device },
                { label: "â˜ï¸ AWS", x: AWS_LEFT, y: AWS_TOP, w: 400, h: 300, fill: groupBg.aws },
                { label: "ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ", x: 590, y: 70, w: 140, h: 100, fill: "rgba(233, 30, 99, 0.12)" },
            ];
            regions.forEach(r => drawGroup(g, r));

            // VPC (AWSå†…)
            const VPC_LEFT = 180;
            const VPC_RIGHT = 420;
            const VPC_TOP = 60;
            const VPC_BOTTOM = 200;
            g.append("rect")
                .attr("x", VPC_LEFT)
                .attr("y", VPC_TOP)
                .attr("width", VPC_RIGHT - VPC_LEFT)
                .attr("height", VPC_BOTTOM - VPC_TOP)
                .attr("rx", 10)
                .attr("fill", "rgba(76, 175, 80, 0.1)")
                .attr("stroke", "rgba(76, 175, 80, 0.4)")
                .attr("stroke-dasharray", "6,4");

            g.append("text")
                .attr("x", VPC_LEFT + 15)
                .attr("y", VPC_TOP + 22)
                .attr("fill", "#888")
                .style("font-size", "10px")
                .text("VPC / Security Group");

            // ãƒãƒ¼ãƒ‰å®šç¾©ï¼ˆYåº§æ¨™ã‚’æƒãˆã¦æ°´å¹³ç·šã«ã™ã‚‹ï¼‰
            const MAIN_Y = 130;  // ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã®Yåº§æ¨™ã‚’çµ±ä¸€
            const netNodes = [
                // Layer 0: ãƒ¢ãƒã‚¤ãƒ«
                { id: "beampro", label: "Beam Pro", x: 70, y: MAIN_Y, color: colors.app, emoji: "ğŸ“±", w: 100, h: 45 },

                // Layer 1: AWS/VPCå†…
                { id: "ec2", label: "EC2", sublabel: "Elastic IP", x: 250, y: MAIN_Y, color: colors.aws, emoji: "ğŸ–¥ï¸", w: 100, h: 50 },
                { id: "tunnel", label: "cloudflared", sublabel: "Tunnel", x: 370, y: MAIN_Y, color: colors.aws, emoji: "ğŸ”—", w: 90, h: 50 },

                // AWSå†…ï¼ˆVPCå¤–ï¼‰
                { id: "cw", label: "CloudWatch", x: 260, y: 265, color: colors.app, emoji: "ğŸ“Š", w: 110, h: 45 },
                { id: "s3", label: "S3 (ãƒ­ã‚°)", x: 390, y: 265, color: colors.app, emoji: "ğŸ—‚ï¸", w: 90, h: 45 },

                // Layer 2: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆï¼ˆcloudflaredã¨åŒã˜Yåº§æ¨™ï¼‰
                { id: "cf", label: "Cloudflare", x: 660, y: MAIN_Y, color: colors.external, emoji: "â˜ï¸", w: 100, h: 45 },
            ];

            const nodeMap = {};
            netNodes.forEach(n => nodeMap[n.id] = n);

            // === ã‚¨ãƒƒã‚¸æç”» ===
            const BOUNDARY_OFFSET = 15;

            // 1. Beam Pro â†’ EC2ï¼ˆYåº§æ¨™ãŒåŒã˜ãªã®ã§ç›´ç·šï¼‰
            const beampro = nodeMap["beampro"];
            const ec2 = nodeMap["ec2"];
            g.append("path")
                .attr("class", "link")
                .attr("d", straightPath(beampro.x + beampro.w/2, beampro.y, ec2.x - ec2.w/2, ec2.y))
                .attr("marker-end", "url(#arrow-network)");
            g.append("text")
                .attr("x", (beampro.x + beampro.w/2 + ec2.x - ec2.w/2) / 2)
                .attr("y", beampro.y - 10)
                .attr("class", "link-label")
                .text("SSH:22");

            // 2. EC2 â†’ cloudflaredï¼ˆVPCå†…ã€ç›´ç·šï¼‰
            const tunnel = nodeMap["tunnel"];
            g.append("path")
                .attr("class", "link")
                .attr("d", straightPath(ec2.x + ec2.w/2, ec2.y, tunnel.x - tunnel.w/2, tunnel.y))
                .attr("marker-end", "url(#arrow-network)");

            // 3. cloudflared â†’ Cloudflareï¼ˆYåº§æ¨™ãŒåŒã˜ãªã®ã§ç›´ç·šï¼‰
            const cf = nodeMap["cf"];
            g.append("path")
                .attr("class", "link")
                .attr("d", straightPath(tunnel.x + tunnel.w/2, tunnel.y, cf.x - cf.w/2, cf.y))
                .attr("marker-end", "url(#arrow-network)");

            // 4. EC2 â†’ CloudWatchï¼ˆä¸‹æ–¹å‘ï¼‰
            const cw = nodeMap["cw"];
            g.append("path")
                .attr("class", "link")
                .attr("d", straightPath(ec2.x, ec2.y + ec2.h/2, cw.x, cw.y - cw.h/2))
                .attr("marker-end", "url(#arrow-network)");
            g.append("text")
                .attr("x", ec2.x - 25)
                .attr("y", (ec2.y + ec2.h/2 + cw.y - cw.h/2) / 2)
                .attr("class", "link-label")
                .text("IAM");

            // 5. EC2 â†’ S3ï¼ˆæ–œã‚ä¸‹ï¼‰
            const s3 = nodeMap["s3"];
            g.append("path")
                .attr("class", "link")
                .attr("d", curvedPath(ec2.x + ec2.w/2, ec2.y + ec2.h/2, s3.x, s3.y - s3.h/2, 0.05))
                .attr("marker-end", "url(#arrow-network)");

            // ãƒãƒ¼ãƒ‰æç”»
            netNodes.forEach(n => drawNode(g, n, true));
        }

        // ========================================
        // 9. AWSæ¨©é™æ§‹æˆå›³
        // ========================================
        function drawAWSPermissionDiagram() {
            const container = d3.select("#diagram-aws-permission");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, 900, 480])
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%")
                .style("height", "480px");

            addArrowMarker(svg, "arrow-perm");

            const g = svg.append("g").attr("transform", "translate(100, 40)");

            // 3æ®µéšã®ãƒ¬ãƒ™ãƒ«
            const levels = [
                { label: "ãƒ¬ãƒ™ãƒ«1: ãƒ«ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼", sublabel: "ğŸ” å…¨æ¨©é™ï¼ˆåˆå›ã®ã¿ä½¿ç”¨â†’å°å°ï¼‰", y: 50, color: colors.external, bg: "rgba(244, 67, 54, 0.12)" },
                { label: "ãƒ¬ãƒ™ãƒ«2: ç®¡ç†è€…IAMãƒ¦ãƒ¼ã‚¶ãƒ¼", sublabel: "ğŸ‘¤ AdministratorAccess", y: 170, color: colors.service, bg: "rgba(76, 175, 80, 0.12)" },
                { label: "ãƒ¬ãƒ™ãƒ«3: EC2ç”¨IAMãƒ­ãƒ¼ãƒ«", sublabel: "ğŸ« å¿…è¦æœ€å°é™ã®æ¨©é™ï¼ˆè‡ªå‹•èªè¨¼ï¼‰", y: 290, color: colors.app, bg: groupBg.app },
            ];

            levels.forEach((level, i) => {
                // èƒŒæ™¯
                g.append("rect")
                    .attr("x", 0)
                    .attr("y", level.y - 35)
                    .attr("width", 400)
                    .attr("height", 70)
                    .attr("rx", 14)
                    .attr("fill", level.bg)
                    .attr("stroke", level.color)
                    .attr("stroke-width", 2);

                // ãƒ©ãƒ™ãƒ«
                g.append("text")
                    .attr("x", 200)
                    .attr("y", level.y - 5)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#fff")
                    .style("font-size", "15px")
                    .style("font-weight", "700")
                    .text(level.label);

                g.append("text")
                    .attr("x", 200)
                    .attr("y", level.y + 18)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#aaa")
                    .style("font-size", "12px")
                    .text(level.sublabel);

                // çŸ¢å°
                if (i < levels.length - 1) {
                    const next = levels[i + 1];
                    g.append("path")
                        .attr("class", "link")
                        .attr("d", `M200,${level.y + 35} L200,${next.y - 35}`)
                        .attr("marker-end", "url(#arrow-perm)");

                    const labelText = i === 0
                        ? "åˆå›ã®ã¿ä½œæˆ â†’ ãƒ«ãƒ¼ãƒˆã¯å°å°"
                        : "æ¡ˆä»¶ã”ã¨ã«ä½œæˆ (aws login)";

                    g.append("text")
                        .attr("x", 420)
                        .attr("y", (level.y + next.y) / 2)
                        .attr("fill", "#888")
                        .style("font-size", "11px")
                        .text(labelText);
                }
            });

            // EC2ã¸ã®ã‚¢ã‚¿ãƒƒãƒ
            g.append("rect")
                .attr("x", 500)
                .attr("y", 255)
                .attr("width", 150)
                .attr("height", 70)
                .attr("rx", 12)
                .attr("fill", colors.aws)
                .style("filter", "drop-shadow(3px 3px 6px rgba(0,0,0,0.3))");

            g.append("text")
                .attr("x", 575)
                .attr("y", 295)
                .attr("text-anchor", "middle")
                .attr("fill", "#fff")
                .style("font-size", "13px")
                .style("font-weight", "600")
                .text("ğŸ–¥ï¸ EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹");

            g.append("path")
                .attr("class", "link")
                .attr("d", "M400,290 L500,290")
                .attr("marker-end", "url(#arrow-perm)");

            g.append("text")
                .attr("x", 450)
                .attr("y", 280)
                .attr("class", "link-label")
                .text("ã‚¢ã‚¿ãƒƒãƒ");

            // è¡¨
            const tableData = [
                ["ãƒ¬ãƒ™ãƒ«", "ãƒ¦ãƒ¼ã‚¶ãƒ¼", "ç”¨é€”", "èªè¨¼"],
                ["1", "ãƒ«ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼", "åˆæœŸè¨­å®šã®ã¿", "MFAå¿…é ˆã€å°å°"],
                ["2", "ç®¡ç†è€…IAM", "EC2/IAMä½œæˆ", "aws login"],
                ["3", "EC2ç”¨ãƒ­ãƒ¼ãƒ«", "EC2å†…AWSæ“ä½œ", "è‡ªå‹•ï¼ˆä¸è¦ï¼‰"],
            ];

            const tableG = g.append("g").attr("transform", "translate(0, 380)");

            tableData.forEach((row, i) => {
                const y = i * 26;
                const fill = i === 0 ? "rgba(255,255,255,0.1)" : "transparent";

                tableG.append("rect")
                    .attr("x", 0)
                    .attr("y", y)
                    .attr("width", 650)
                    .attr("height", 24)
                    .attr("fill", fill);

                row.forEach((cell, j) => {
                    const x = [30, 130, 300, 500][j];
                    tableG.append("text")
                        .attr("x", x)
                        .attr("y", y + 17)
                        .attr("fill", i === 0 ? "#fff" : "#aaa")
                        .style("font-size", "12px")
                        .style("font-weight", i === 0 ? "700" : "400")
                        .text(cell);
                });
            });
        }

        // ========================================
        // 10. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«EC2ã‹ã‚‰ã®æ¡ˆä»¶ç®¡ç†ï¼ˆå·¦â†’å³ãƒ•ãƒ­ãƒ¼å¾¹åº•ï¼‰
        // ========================================
        function drawControlMgmtDiagram() {
            const container = d3.select("#diagram-control-mgmt");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, 1000, 480])
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%")
                .style("height", "480px");

            addArrowMarker(svg, "arrow-ctrl");

            const g = svg.append("g").attr("transform", "translate(20, 20)");

            // Beam Pro
            drawGroup(g, { label: "ğŸ“± Beam Pro", x: 0, y: 80, w: 130, h: 100, fill: groupBg.device, dashed: true });
            drawNode(g, { label: "Termius", x: 65, y: 140, color: colors.app, emoji: "ğŸ’»", w: 100, h: 45 });

            // AWS
            drawGroup(g, { label: "â˜ï¸ AWS", x: 150, y: 10, w: 680, h: 340, fill: groupBg.aws, dashed: false });

            // Control EC2ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆå†…éƒ¨ã«tmuxã¨ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¸¦ã«é…ç½®ï¼‰
            g.append("rect")
                .attr("x", 170)
                .attr("y", 50)
                .attr("width", 200)
                .attr("height", 160)
                .attr("rx", 12)
                .attr("fill", "rgba(33, 150, 243, 0.15)")
                .attr("stroke", "rgba(33, 150, 243, 0.5)")
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", "6,4");

            g.append("text")
                .attr("x", 185)
                .attr("y", 75)
                .attr("class", "group-label")
                .style("font-size", "11px")
                .text("ğŸ® ar-dev-controlï¼ˆå¸¸æ™‚èµ·å‹•ï¼‰");

            // Control EC2å†…éƒ¨ãƒ„ãƒ¼ãƒ«ï¼ˆç¸¦ã«ä¸¦åˆ—ã€åŒã˜Xåº§æ¨™ï¼‰
            const ctrlX = 270;
            drawNode(g, { label: "tmux [ctrl]", sublabel: "ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†", x: ctrlX, y: 115, color: colors.app, emoji: "ğŸ“º", w: 120, h: 45 });
            drawNode(g, { label: "ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ", sublabel: "AWS CLI", x: ctrlX, y: 175, color: colors.service, emoji: "âš™ï¸", w: 120, h: 45 });

            // æ¡ˆä»¶EC2ï¼ˆç¸¦ã«ä¸¦åˆ—ï¼‰
            const projX = 550;
            const projects = [
                { label: "ğŸŸ¢ æ¡ˆä»¶A EC2", x: projX, y: 90, color: colors.aws, emoji: "ğŸ–¥ï¸", w: 130, h: 50 },
                { label: "ğŸŸ¡ æ¡ˆä»¶B EC2", x: projX, y: 165, color: colors.aws, emoji: "ğŸ–¥ï¸", w: 130, h: 50 },
                { label: "âš« æ¡ˆä»¶C EC2", sublabel: "åœæ­¢ä¸­", x: projX, y: 240, color: colors.auto, emoji: "ğŸ–¥ï¸", w: 130, h: 50 },
            ];
            projects.forEach(p => drawNode(g, p, true));

            // æ¥ç¶šç·š: Termius â†’ Control EC2ï¼ˆå·¦â†’å³ï¼‰
            // Termius: x=65, w=100 â†’ å³è¾º=115
            // Control EC2ã‚°ãƒ«ãƒ¼ãƒ—: x=170 â†’ å·¦è¾º=170
            g.append("path")
                .attr("class", "link")
                .attr("d", straightPath(115, 140, 170, 140))
                .attr("marker-end", "url(#arrow-ctrl)");

            g.append("text")
                .attr("x", 142)
                .attr("y", 130)
                .attr("class", "link-label")
                .text("SSH");

            // tmux â†’ æ¡ˆä»¶EC2ï¼ˆå·¦â†’å³ï¼‰
            const tmuxY = 115;
            [90, 165, 240].forEach((projY, i) => {
                const curve = (projY - tmuxY) * 0.001;  // Yå·®ã«å¿œã˜ãŸæ›²ç‡
                g.append("path")
                    .attr("class", "link")
                    .attr("d", curvedPath(330, tmuxY, projX - 65, projY, curve))
                    .attr("marker-end", "url(#arrow-ctrl)");
            });

            g.append("text")
                .attr("x", 400)
                .attr("y", 80)
                .attr("class", "link-label")
                .text("Alt+] ã§åˆ‡æ›¿");

            // ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â†’ æ¡ˆä»¶EC2ï¼ˆå·¦â†’å³ï¼‰
            const scriptY = 175;
            [90, 165, 240].forEach((projY, i) => {
                const curve = (projY - scriptY) * 0.0008;
                g.append("path")
                    .attr("class", "link")
                    .attr("d", curvedPath(330, scriptY, projX - 65, projY, curve))
                    .attr("stroke-dasharray", "4,3")
                    .attr("marker-end", "url(#arrow-ctrl)");
            });

            g.append("text")
                .attr("x", 400)
                .attr("y", 220)
                .attr("class", "link-label")
                .text("èµ·å‹•/åœæ­¢");

            // æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ï¼ˆå›³ã®ä¸‹éƒ¨ã«é…ç½®ï¼‰
            const infoG = g.append("g").attr("transform", "translate(150, 360)");

            // ç®¡ç†ã‚³ãƒãƒ³ãƒ‰
            infoG.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", 280)
                .attr("height", 140)
                .attr("rx", 10)
                .attr("fill", "rgba(0,0,0,0.3)");

            infoG.append("text")
                .attr("x", 15)
                .attr("y", 28)
                .attr("fill", "#fff")
                .style("font-weight", "700")
                .style("font-size", "13px")
                .text("âš™ï¸ ç®¡ç†ã‚³ãƒãƒ³ãƒ‰");

            const commands = [
                "list-projects     : æ¡ˆä»¶ä¸€è¦§",
                "start-project XX  : æ¡ˆä»¶XXèµ·å‹•",
                "stop-project XX   : æ¡ˆä»¶XXåœæ­¢",
                "start-all         : å…¨æ¡ˆä»¶èµ·å‹•",
                "stop-all          : å…¨æ¡ˆä»¶åœæ­¢",
            ];

            commands.forEach((cmd, i) => {
                infoG.append("text")
                    .attr("x", 15)
                    .attr("y", 55 + i * 18)
                    .attr("fill", "#aaa")
                    .style("font-family", "monospace")
                    .style("font-size", "11px")
                    .text(cmd);
            });

            // ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰
            infoG.append("rect")
                .attr("x", 300)
                .attr("y", 0)
                .attr("width", 280)
                .attr("height", 140)
                .attr("rx", 10)
                .attr("fill", "rgba(0,0,0,0.3)");

            infoG.append("text")
                .attr("x", 315)
                .attr("y", 28)
                .attr("fill", "#fff")
                .style("font-weight", "700")
                .style("font-size", "13px")
                .text("âŒ¨ï¸ tmux ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰");

            const keybinds = [
                "Alt + ]  â†’ æ¬¡ã®window",
                "Alt + [  â†’ å‰ã®window",
                "",
                "âœ… ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã ã‘ã§å…¨æ“ä½œå®Œçµ",
                "âœ… Beam Pro ã«è§¦ã‚‹å¿…è¦ãªã—",
                "âœ… è¤‡æ•°æ¡ˆä»¶ã®ç¬æ™‚åˆ‡ã‚Šæ›¿ãˆ",
            ];

            keybinds.forEach((kb, i) => {
                infoG.append("text")
                    .attr("x", 315)
                    .attr("y", 55 + i * 16)
                    .attr("fill", "#aaa")
                    .style("font-size", "11px")
                    .text(kb);
            });
        }

        // ========================================
        // åˆæœŸæç”»
        // ========================================
        drawOverallDiagram();

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«æç”»
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                switch(tabId) {
                    case 'overall': drawOverallDiagram(); break;
                    case 'ec2-internal': drawEC2InternalDiagram(); break;
                    case 'work-division': drawWorkDivisionDiagram(); break;
                    case 'lifecycle': drawLifecycleDiagram(); break;
                    case 'auto-stop': drawAutoStopDiagram(); break;
                    case 'cost': drawCostDiagram(); break;
                    case 'file-structure': drawFileStructureDiagram(); break;
                    case 'network': drawNetworkDiagram(); break;
                    case 'aws-permission': drawAWSPermissionDiagram(); break;
                    case 'control-mgmt': drawControlMgmtDiagram(); break;
                }
            });
        });
    </script>
</body>
</html>
